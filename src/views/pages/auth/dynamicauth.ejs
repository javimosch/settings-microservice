<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Auth Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between h-16">
        <div class="flex items-center space-x-4">
          <a href="/dashboard" class="text-xl font-bold text-gray-800">Settings Microservice</a>
          <span class="text-gray-400">/</span>
          <span class="text-gray-600">Dynamic Auth</span>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-gray-600">Welcome, <%= user %></span>
          <a href="/logout" class="text-red-600 hover:text-red-800">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto py-6 px-4" id="app">
    <div>
      <!-- Organization Selector -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Organization:</label>
        <select 
          v-model="selectedOrgId"
          @change="loadDynamicAuth()"
          class="w-full md:w-96 border border-gray-300 rounded px-3 py-2"
        >
          <option value="">-- Select Organization --</option>
          <option v-for="org in organizations" :key="org._id" :value="org._id">{{ org.name }}</option>
        </select>
        
        <!-- Show selected org ID -->
        <div v-if="selectedOrgId" class="mt-3 p-3 bg-blue-50 rounded border border-blue-200">
          <div class="flex items-center justify-between">
            <div>
              <span class="text-xs font-medium text-blue-800">Organization ID:</span>
              <code class="ml-2 bg-white px-2 py-1 rounded text-sm text-blue-600 font-mono">{{ selectedOrgId }}</code>
            </div>
            <button 
              @click="copyToClipboard(selectedOrgId)" 
              class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
              title="Copy to clipboard"
            >
              ðŸ“‹ Copy
            </button>
          </div>
        </div>
      </div>

      <div v-if="selectedOrgId" class="bg-white rounded-lg shadow">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-2xl font-semibold">Dynamic Auth Configurations</h2>
              <p class="text-gray-600 mt-1">Configure HTTP and JavaScript-based authentication for external APIs</p>
            </div>
            <button @click="openForm()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
              + New Auth Config
            </button>
          </div>

          <!-- Auth List -->
          <div class="space-y-4">
            <div v-for="auth in authConfigs" :key="auth._id" class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center gap-3">
                    <h3 class="text-lg font-semibold">{{ auth.name }}</h3>
                    <span :class="['px-2 py-1 rounded text-xs font-semibold', auth.type === 'http' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800']">
                      {{ auth.type.toUpperCase() }}
                    </span>
                    <span :class="['px-2 py-1 rounded text-xs font-semibold', auth.enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800']">
                      {{ auth.enabled ? 'ENABLED' : 'DISABLED' }}
                    </span>
                  </div>
                  <p class="text-sm text-gray-600 mt-1">{{ auth.description || 'No description' }}</p>
                  
                  <!-- HTTP Details -->
                  <div v-if="auth.type === 'http'" class="mt-3 text-sm">
                    <div class="flex items-center gap-2 text-gray-700">
                      <span class="font-medium">URL:</span>
                      <code class="bg-gray-100 px-2 py-1 rounded">{{ auth.http.url }}</code>
                    </div>
                    <div class="flex items-center gap-2 text-gray-700 mt-1">
                      <span class="font-medium">Method:</span>
                      <code class="bg-gray-100 px-2 py-1 rounded">{{ auth.http.method || 'POST' }}</code>
                    </div>
                  </div>

                  <!-- JS Details -->
                  <div v-if="auth.type === 'js'" class="mt-3">
                    <details class="text-sm">
                      <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">View JavaScript Code</summary>
                      <pre class="mt-2 bg-gray-50 p-3 rounded overflow-x-auto text-xs"><code>{{ auth.jsCode }}</code></pre>
                    </details>
                  </div>

                  <div class="flex items-center gap-4 mt-3 text-sm text-gray-600">
                    <span>Cache TTL: {{ auth.cacheTTLSeconds }}s</span>
                    <span>Updated: {{ new Date(auth.updatedAt).toLocaleString() }}</span>
                  </div>
                </div>

                <div class="flex flex-col gap-2 ml-4">
                  <button @click="testAuth(auth)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded text-sm">
                    Test
                  </button>
                  <button @click="editAuth(auth)" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded text-sm">
                    Edit
                  </button>
                  <button @click="invalidateCache(auth._id)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1 rounded text-sm">
                    Clear Cache
                  </button>
                  <button @click="deleteAuth(auth._id)" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded text-sm">
                    Delete
                  </button>
                </div>
              </div>
            </div>

            <div v-if="authConfigs.length === 0" class="text-center py-12 text-gray-500">
              <p class="text-lg">No authentication configurations yet</p>
              <p class="text-sm mt-2">Click "New Auth Config" to create one</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Modal -->
      <div v-show="showForm" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 my-8">
          <h3 class="text-xl font-bold mb-4">{{ editingId ? 'Edit' : 'Create' }} Auth Configuration</h3>
          <form @submit.prevent="saveAuth()">
            
            <!-- Name -->
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2">Name *</label>
              <input 
                v-model="form.name"
                type="text" 
                required
                placeholder="e.g., default, oauth2, api-key-auth"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
              <p class="text-xs text-gray-500 mt-1">Used in X-Auth-Name header when calling external APIs</p>
            </div>

            <!-- Type -->
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2">Type *</label>
              <div class="flex gap-4">
                <label class="flex items-center">
                  <input type="radio" v-model="form.type" value="http" class="mr-2" />
                  <span>HTTP - Call external auth service</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" v-model="form.type" value="js" class="mr-2" />
                  <span>JavaScript - Custom validation code</span>
                </label>
              </div>
            </div>

            <!-- HTTP Configuration -->
            <div v-if="form.type === 'http'" class="mb-4 p-4 bg-blue-50 rounded">
              <h4 class="font-semibold mb-3">HTTP Configuration</h4>
              
              <div class="mb-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">URL *</label>
                <input 
                  v-model="form.http.url"
                  type="url" 
                  required
                  placeholder="https://auth.example.com/validate"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                />
              </div>

              <div class="mb-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Method</label>
                <select v-model="form.http.method" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                  <option>GET</option>
                  <option>POST</option>
                  <option>PUT</option>
                  <option>DELETE</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Headers (JSON)</label>
                <textarea 
                  v-model="headersJson"
                  rows="3"
                  placeholder='{"Authorization": "{{headers.authorization}}", "X-Custom": "value"}'
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">Use Mustache templates: {{'{{'}}headers.authorization}}, {{'{{'}}query.token}}, {{'{{'}}body.key}}</p>
              </div>

              <div class="mb-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Query Params (JSON)</label>
                <textarea 
                  v-model="queryParamsJson"
                  rows="2"
                  placeholder='{"token": "{{headers.authorization}}"}'
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Body Params (JSON)</label>
                <textarea 
                  v-model="bodyParamsJson"
                  rows="3"
                  placeholder='{"token": "{{headers.authorization}}", "scope": "read"}'
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
                ></textarea>
              </div>
            </div>

            <!-- JavaScript Configuration -->
            <div v-if="form.type === 'js'" class="mb-4 p-4 bg-purple-50 rounded">
              <h4 class="font-semibold mb-3">JavaScript Configuration</h4>
              
              <div class="mb-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">JavaScript Code *</label>
                <textarea 
                  v-model="form.jsCode"
                  rows="12"
                  required
                  placeholder="const token = req.headers.authorization?.split(' ')[1];
if (token === 'valid-key') {
  return {
    ok: true,
    subject: { id: 'user-1', type: 'api-key' },
    permissions: { globalSettings: { read: true, write: true } }
  };
}
return { ok: false };"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
                ></textarea>
                <div class="text-xs text-gray-600 mt-2 space-y-1">
                  <p>Available variables: <code class="bg-gray-200 px-1">req</code> (headers, query, body, ip, path), <code class="bg-gray-200 px-1">axios</code></p>
                  <p>Must return: <code class="bg-gray-200 px-1">{{ '{' }}ok: boolean, subject?: {{'{'}}id, type}, permissions?: {{'{'}}...}, ttl?: number}</code></p>
                </div>
              </div>
            </div>

            <!-- Common fields -->
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2">Cache TTL (seconds)</label>
              <input 
                v-model.number="form.cacheTTLSeconds"
                type="number" 
                min="0"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
              <p class="text-xs text-gray-500 mt-1">How long to cache successful auth results (0 = no caching)</p>
            </div>

            <div class="mb-4">
              <label class="flex items-center">
                <input type="checkbox" v-model="form.enabled" class="mr-2" />
                <span class="text-gray-700 text-sm font-bold">Enabled</span>
              </label>
            </div>

            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
              <textarea 
                v-model="form.description"
                rows="2"
                placeholder="Optional description"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              ></textarea>
            </div>

            <div class="flex justify-end space-x-3">
              <button 
                type="button"
                @click="closeForm()"
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded"
              >
                Cancel
              </button>
              <button 
                type="submit"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
              >
                Save
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Test Modal -->
      <div v-show="showTestModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
          <h3 class="text-xl font-bold mb-4">Test Auth: {{ testingAuth?.name }}</h3>
          
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Test Headers (JSON)</label>
            <textarea 
              v-model="testData.headers"
              rows="4"
              placeholder='{"authorization": "Bearer test-token"}'
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
            ></textarea>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Test Query (JSON)</label>
            <textarea 
              v-model="testData.query"
              rows="2"
              placeholder='{}'
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
            ></textarea>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Test Body (JSON)</label>
            <textarea 
              v-model="testData.body"
              rows="2"
              placeholder='{}'
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 font-mono text-sm"
            ></textarea>
          </div>

          <div v-if="testResult" class="mb-4 p-4 rounded" :class="testResult.success ? 'bg-green-50' : 'bg-red-50'">
            <h4 class="font-semibold mb-2" :class="testResult.success ? 'text-green-800' : 'text-red-800'">
              {{ testResult.success ? 'âœ“ Success' : 'âœ— Failed' }}
            </h4>
            <pre class="text-sm overflow-x-auto"><code>{{ JSON.stringify(testResult.result, null, 2) }}</code></pre>
          </div>

          <div class="flex justify-end space-x-3">
            <button 
              type="button"
              @click="closeTestModal()"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded"
            >
              Close
            </button>
            <button 
              type="button"
              @click="runTest()"
              class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
            >
              Run Test
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          organizations: [],
          selectedOrgId: '',
          authConfigs: [],
          showForm: false,
          showTestModal: false,
          editingId: null,
          testingAuth: null,
          testResult: null,
          headersJson: '{}',
          queryParamsJson: '{}',
          bodyParamsJson: '{}',
          testData: {
            headers: '{"authorization": "Bearer demo-token-123"}',
            query: '{}',
            body: '{}'
          },
          form: {
            name: '',
            type: 'http',
            http: {
              url: '',
              method: 'POST',
              headers: {},
              queryParams: {},
              bodyParams: {}
            },
            jsCode: '',
            cacheTTLSeconds: 300,
            enabled: true,
            description: ''
          }
        };
      },
      mounted() {
        this.loadOrganizations();
      },
      methods: {
        async loadOrganizations() {
          const data = await fetchAPI('/api/internal/organizations');
          this.organizations = data;
        },

        async loadDynamicAuth() {
          if (!this.selectedOrgId) return;
          const data = await fetchAPI(`/api/internal/dynamicauth?organizationId=${this.selectedOrgId}`);
          this.authConfigs = data;
        },

        openForm() {
          this.editingId = null;
          this.resetForm();
          this.showForm = true;
        },

        editAuth(auth) {
          this.editingId = auth._id;
          this.form = {
            name: auth.name,
            type: auth.type,
            http: auth.http || { url: '', method: 'POST', headers: {}, queryParams: {}, bodyParams: {} },
            jsCode: auth.jsCode || '',
            cacheTTLSeconds: auth.cacheTTLSeconds,
            enabled: auth.enabled,
            description: auth.description || ''
          };
          this.headersJson = JSON.stringify(this.form.http.headers || {}, null, 2);
          this.queryParamsJson = JSON.stringify(this.form.http.queryParams || {}, null, 2);
          this.bodyParamsJson = JSON.stringify(this.form.http.bodyParams || {}, null, 2);
          this.showForm = true;
        },

        async saveAuth() {
          let payload = { ...this.form, organizationId: this.selectedOrgId };

          if (this.form.type === 'http') {
            try {
              payload.http = {
                url: this.form.http.url,
                method: this.form.http.method,
                headers: this.headersJson ? JSON.parse(this.headersJson) : {},
                queryParams: this.queryParamsJson ? JSON.parse(this.queryParamsJson) : {},
                bodyParams: this.bodyParamsJson ? JSON.parse(this.bodyParamsJson) : {}
              };
            } catch (e) {
              showNotification('Invalid JSON in HTTP configuration', 'error');
              return;
            }
          }

          const url = this.editingId 
            ? `/api/internal/dynamicauth/${this.editingId}`
            : '/api/internal/dynamicauth';
          const method = this.editingId ? 'PUT' : 'POST';

          await fetchAPI(url, { method, body: JSON.stringify(payload) });
          
          this.closeForm();
          await this.loadDynamicAuth();
          showNotification('Auth configuration saved successfully');
        },

        async deleteAuth(id) {
          if (!confirm('Are you sure you want to delete this auth configuration?')) return;
          await fetchAPI(`/api/internal/dynamicauth/${id}`, { method: 'DELETE' });
          await this.loadDynamicAuth();
          showNotification('Auth configuration deleted successfully');
        },

        async invalidateCache(id) {
          await fetchAPI(`/api/internal/dynamicauth/${id}/invalidate-cache`, { method: 'POST' });
          showNotification('Cache invalidated successfully');
        },

        testAuth(auth) {
          this.testingAuth = auth;
          this.testResult = null;
          this.showTestModal = true;
        },

        async runTest() {
          try {
            const payload = {
              headers: JSON.parse(this.testData.headers),
              query: JSON.parse(this.testData.query),
              body: JSON.parse(this.testData.body)
            };

            const result = await fetchAPI(`/api/internal/dynamicauth/${this.testingAuth._id}/try`, {
              method: 'POST',
              body: JSON.stringify(payload)
            });

            this.testResult = result;
          } catch (e) {
            this.testResult = { success: false, result: { error: e.message } };
          }
        },

        closeForm() {
          this.showForm = false;
          this.editingId = null;
          this.resetForm();
        },

        closeTestModal() {
          this.showTestModal = false;
          this.testingAuth = null;
          this.testResult = null;
        },

        resetForm() {
          this.form = {
            name: '',
            type: 'http',
            http: {
              url: '',
              method: 'POST',
              headers: {},
              queryParams: {},
              bodyParams: {}
            },
            jsCode: '',
            cacheTTLSeconds: 300,
            enabled: true,
            description: ''
          };
          this.headersJson = '{}';
          this.queryParamsJson = '{}';
          this.bodyParamsJson = '{}';
        },

        copyToClipboard(text) {
          navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!');
          }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('Copied to clipboard!');
          });
        }
      }
    }).mount('#app');

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white z-50`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    async function fetchAPI(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }
        return data;
      } catch (error) {
        showNotification(error.message, 'error');
        throw error;
      }
    }
  </script>
</body>
</html>
